<div class="container-xxl p-5" id="requests">
  <nav class="navbar lst fixed-top">
    <div class="container-fluid">
      <%= link_to root_path,  class:"navbar-brand mb-0 h1 lsttxt neon" do %>
        D<%= image_tag "/assets/comspec.png", style:"width:auto;height:25px;", class:"mb-1" %>IM
      <% end %>
      <ul class="nav justify-content-end">
        <li class="nav-item">
          <%= link_to root_path do %>
            <i class="nav-link fa fa-solid fa-home usr" title="HOME"></i>
          <% end %>
        </li>
        <li class="nav-item">
          <%= link_to devices_path do %>
            <i class="nav-link fa fa-solid fa-code-fork usr text-white" title="SNMP Device"></i>
          <% end %>
        </li>
        <li class="nav-item">
          <%= link_to ssms_path do %>
            <i class="nav-link fa fa-solid fa-sitemap usr" title="Server Status Monitoring"></i>
          <% end %>
        </li>
        <li class="nav-item">
          <%= link_to users_path do %>
            <i class="nav-link fa fa-solid fa-user usr" title="Accounts"></i>
          <% end %>
        </li>
        <li class="nav-item">
          <%= link_to logout_path, data: { confirm: 'Are you sure you want to logout?' } do %>
            <i class="nav-link fa fa-sign-in usr" title="Logged out"></i>
          <%end%>
        </li>
      </ul>
    </div>
  </nav>

  <div class="row mt-5">
    <p id="notice"><%= notice %></p>
    <div class="col-sm-12 mt-2">
      <div class="card">
        <div class="card-body">
          <div class="container">
            <div class="row">
              <div class="col">
                <h5 class="card-title text-light"><i class="fa fa-solid fa-code-fork"> Simple Network Management Protocol (SNMP) Device</i></h5>
              </div>
              <div class="col">
                <%= form_tag devices_path, :method => "GET" do %>
                  <div class="input-group input-group-sm mb-3">
                    <%= text_field_tag :search, params[:search], class:"form-control", placeholder:"Search Device Name" %>
                    <%= submit_tag "Search", class:"btn btn-outline-secondary" do %>
                      <i class="fa fa-solid fa-search"></i>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover" style="border-radius:25px;">
                <thead>
                  <tr>
                    <th>Device Name</th>
                    <th class="text-center">Ipaddress</th>
                    <th colspan="2" class="text-center"></th>
                    <th class="text-center">Alarm</th>
                    <th colspan="3" style="text-align:center;">Actions</th>
                  </tr>
                </thead>

                <tbody>
                  <% @devices.each do |device| %>
                    <tr>
                      <td><%= link_to device do %> <%= device.unitname %> <%end%></td>
                      <td class="text-center"><%= device.ipaddress %></td>
                      <td class="text-center"><%= device.sensore_type %></td>
                      <td class="text-center">
                        <%=
                          checkIP = device.ipaddress
                          scanIP = Net::Ping::External.new(checkIP,timeout=0.9)
                          resultIP = p scanIP.ping?
                          if resultIP == true
                            host = device.ipaddress.freeze
                            typeValue = { 'OCTET STRING' => :to_f, 'INTEGER' => :to_f, 'TimeTicks' => :to_s }.freeze
                            registers = [device.oid ]
                            params_array = {}
                            SNMP::Manager.open(host: host, :community => device.community) do |manager|
                              manager.load_module('UPS-MIB')
                              response = manager.get(registers)
                              response.each_varbind do |vb|
                                if method = typeValue[vb.value.asn1_type]
                                  params_array = vb.value.send(method)/10
                                else
                                  puts "Type '#{vb.value.asn1_type}' not recognized!"
                                end
                              end
                            end
                            pp params_array
                          else
                            "SNMP Can not display your sensor/device check your LAN or IP Address to fix this error.}"
                          end
                        %>
                        <%=
                          @alert = pp params_array
                          if @alert == device.alarm.to_f/10
                            @alertdata = "alert"
                          else
                            @alertdata = " "
                          end
                        %>
                        <%= tag.p data: {"article-id": @alertdata} %>
                      </td>
                      <td class="text-center"><i class="fa fa-solid fa-clock"></i><%= device.alarm.to_f/10 %></td>
                      <td style="text-align:center;"><%= link_to '', edit_device_path(device), class:"fa fa-solid fa-edit me-md-2", title:"Edit" %></td>
                      <td style="text-align:center;"><%= link_to '', device, method: :delete, data: { confirm: 'Are you sure?' }, class:"fa fa-solid fa-trash", title:"Delete" %></td>
                      <td style="text-align:center;"></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <button class="btn-9">
            <%= link_to new_device_path :class=>"btn1" do %>Add NEW DEVICE<% end %>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
